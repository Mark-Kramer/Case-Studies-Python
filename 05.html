

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Analysis of Coupled Rhythms &#8212; Case Studies in Neural Data Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/mystnb.js"></script>
    <script src="_static/custom.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script async="async" src="_static/thebelab.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="canonical" href="https://mark-kramer.github.io/Case-Studies-Python/05.html" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Filtering Field Data" href="06.html" />
    <link rel="prev" title="The Power Spectrum (Part 2)" href="04.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">


<!-- Opengraph tags -->
<meta property="og:url"         content="https://mark-kramer.github.io/Case-Studies-Python/05.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Analysis of Coupled Rhythms" />
<meta property="og:description" content="Analysis of Coupled Rhythms  <div class="question">   Synopsis  Data: 1 s of ECoG data sampled at 500 Hz from two electrodes for 100 trials.  Goal: Characterize" />
<meta property="og:image"       content="https://mark-kramer.github.io/Case-Studies-Python/_static/logo.png" />

<meta name="twitter:card" content="summary">


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Case Studies in Neural Data Analysis</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  
  <ul class="nav sidenav_l1">
  <li class="">
    <a href="01.html">1. Python for the practicing neuroscientist</a>
  </li>
  <li class="">
    <a href="02.html">2. The Event-Related Potential</a>
  </li>
  <li class="">
    <a href="03.html">3. The Power Spectrum (Part 1)</a>
  </li>
  <li class="">
    <a href="04.html">4. The Power Spectrum (Part 2)</a>
  </li>
  <li class="active">
    <a href="">5. Analysis of Coupled Rhythms</a>
  </li>
  <li class="">
    <a href="06.html">6. Filtering Field Data</a>
  </li>
  <li class="">
    <a href="07.html">7. Cross-Frequency Coupling</a>
  </li>
  <li class="">
    <a href="08.html">8. Basic Analysis of Spike Train Data</a>
  </li>
  <li class="">
    <a href="09.html">9. Point Process Generalized Linear Models</a>
  </li>
  <li class="">
    <a href="10.html">10. Analysis of Rhythmic Spike Train Data</a>
  </li>
  <li class="">
    <a href="11.html">11. Spike-Field Coherence</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">Extra notebooks</p>
</li>
  <li class="">
    <a href="IF.html">12. The integrate and fire neuron</a>
  </li>
  <li class="">
    <a href="HH.html">13. The Hodgkin-Huxley model</a>
  </li>
  <li class="">
    <a href="Perceptron.html">14. Training a Perceptron</a>
  </li>
  <li class="">
    <a href="Backprop.html">15. Backpropagation</a>
  </li>
</ul>
</nav>

 <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse" data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation" title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i class="fas fa-download"></i></button>

            
            <div class="dropdown-buttons">
                <!-- ipynb file if we had a myst markdown file -->
                
                <!-- Download raw file -->
                <a class="dropdown-buttons" href="_sources/05.ipynb"><button type="button" class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip" data-placement="left">.ipynb</button></a>
                <!-- Download PDF via print -->
                <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF" onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
            </div>
            
        </div>

        <!-- Source interaction buttons -->
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
            <div class="dropdown-buttons sourcebuttons">
                <a class="repository-button" href="https://github.com/Mark-Kramer/Case-Studies-Python/"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left" title="Source repository"><i class="fab fa-github"></i>repository</button></a>
                <a class="issues-button" href="https://github.com/Mark-Kramer/Case-Studies-Python//issues/new?title=Issue%20on%20page%20%2F05.html&body=Your%20issue%20content%20here."><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left" title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
                
            </div>
        </div>
        

        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
            <div class="dropdown-buttons">
                
                <a class="binder-button" href="https://mybinder.org/v2/gh/Mark-Kramer/Case-Studies-Python/binder?urlpath=tree/05.ipynb"><button type="button" class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip" data-placement="left"><img class="binder-button-logo" src="_static/images/logo_binder.svg" alt="Interact on binder">Binder</button></a>
                
                
                <button type="button" class="btn btn-secondary topbarbtn thebelab-launch-button" onclick="initThebelab()" title="Launch Thebelab" data-toggle="tooltip" data-placement="left"><i class="fas fa-rocket"></i><span style="margin-left: .4em;">ThebeLab</span></button>
                
            </div>
        </div>
        
    </div>
    <div class="d-none d-md-block col-md-2 bd-toc show">
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#on-ramp-computing-the-coherence-in-python" class="nav-link">On-ramp: computing the coherence in Python</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#introduction" class="nav-link">Introduction</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#background" class="nav-link">Background</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#case-study-data" class="nav-link">Case Study Data</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#goal" class="nav-link">Goal</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#tools" class="nav-link">Tools</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#data-analysis" class="nav-link">Data Analysis</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#visual-inspection" class="nav-link">Visual inspection</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#autocovariance-and-cross-covariance" class="nav-link">Autocovariance and Cross-covariance</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#trial-averaged-spectrum" class="nav-link">Trial-Averaged Spectrum</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#introduction-to-the-coherence" class="nav-link">Introduction to the Coherence</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#simple-scenario-1-phases-align-across-trials" class="nav-link">Simple Scenario 1:  Phases align across trials</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#simple-scenario-2-phases-are-random-across-trials" class="nav-link">Simple Scenario 2: Phases are random across trials</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#summary-of-the-coherence" class="nav-link">Summary of the coherence</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#cross-covariance-and-cross-spectrum" class="nav-link">Cross-Covariance and Cross-Spectrum</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#computing-the-coherence" class="nav-link">Computing the Coherence</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#visualizing-the-phase-difference-across-trials" class="nav-link">Visualizing the Phase Difference across Trials</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#single-trial-coherence" class="nav-link">Single-Trial Coherence</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#relation-between-statistical-modeling-and-coherence" class="nav-link">Relation between Statistical Modeling and Coherence</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#summary" class="nav-link">Summary</a>
        </li>
    
    </ul>
</nav>


    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a id="introduction"></a><a id="top"></a></p>
<div class="section" id="analysis-of-coupled-rhythms">
<h1>Analysis of Coupled Rhythms<a class="headerlink" href="#analysis-of-coupled-rhythms" title="Permalink to this headline">¶</a></h1>
<div class="question">
<p><em><strong>Synopsis</strong></em></p>
<p><strong>Data:</strong> 1 s of ECoG data sampled at 500 Hz from two electrodes for 100 trials.</p>
<p><strong>Goal:</strong> Characterize the coupling of rhythmic activity between the two electrodes.</p>
<p><strong>Tools:</strong> Fourier transform, spectrum, amplitude, coherence, phase.</p>
</div><ul class="simple">
<li><p><a class="reference external" href="#onramp">On-ramp</a></p></li>
<li><p><a class="reference external" href="#background">Background</a></p></li>
<li><p><a class="reference external" href="#case-study-data">Case Study Data</a></p></li>
<li><p><a class="reference external" href="#data-analysis">Data Analysis</a></p>
<ul>
<li><p><a class="reference external" href="#visual-inspection">Visual Inspection</a></p></li>
<li><p><a class="reference external" href="#Autocovariance-and-Cross-covariance">Autocovariance and Cross-covariance</a></p></li>
<li><p><a class="reference external" href="#Trial-Averaged-Spectrum">Trial-Averaged Spectrum</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#sec:coherence">Introduction to the Coherence</a></p>
<ul>
<li><p><a class="reference external" href="#Simple_Scenario_1">Simple Scenario 1: Phases align across trials</a></p></li>
<li><p><a class="reference external" href="#Simple_Scenario_2">Simple Scenario 2: Phases are random across trials</a></p></li>
<li><p><a class="reference external" href="#Summary_of_the_coherence">Summary of the coherence</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#cc_and_cs">Cross-Covariance and Cross-Spectrum</a></p></li>
<li><p><a class="reference external" href="#computing_coherence">Computing the Coherence</a></p>
<ul>
<li><p><a class="reference external" href="#Visualizing_the_Phase_Difference">Visualizing the Phase Difference across Trials</a></p></li>
<li><p><a class="reference external" href="#single_trial_coherence">Single-Trial Coherence</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#Relation_between_Statistical_Modeling_and_Coherence">Relation between Statistical Modeling and Coherence</a></p></li>
<li><p><a class="reference external" href="#summary">Summary</a></p></li>
</ul>
<p><a id="onramp"></a></p>
<div class="section" id="on-ramp-computing-the-coherence-in-python">
<h2>On-ramp: computing the coherence in Python<a class="headerlink" href="#on-ramp-computing-the-coherence-in-python" title="Permalink to this headline">¶</a></h2>
<p>We begin this module with an “<em>on-ramp</em>” to analysis. The purpose of this on-ramp is to introduce you immediately to a core concept in this module: how to compute the coherence in Python. You may not understand all aspects of the program here, but that’s not the point. Instead, the purpose of this on-ramp is to illustrate what <em>can</em> be done. Our advice is to simply run the code below and see what happens …</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import our favorite functions and modules</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">loadmat</span>                    <span class="c1"># To load .mat files</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>                             <span class="c1"># Import plotting functions</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>               <span class="c1"># Change the default figure size</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="s1">&#39;matfiles/ECoG-1.mat&#39;</span><span class="p">)</span>        <span class="c1"># Load the data,</span>
<span class="n">E1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;E1&#39;</span><span class="p">]</span>                              <span class="c1"># ... from the first electrode,</span>
<span class="n">E2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span>                              <span class="c1"># ... and from the second electrode.</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>                             <span class="c1"># Load the time axis,</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                             <span class="c1"># ... to get the sampling interval,</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                                    <span class="c1"># ... and the total time of the recording.</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                              <span class="c1"># Determine the number of sample points per trial</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">T</span>                        <span class="c1"># Scaling constant</span>

<span class="c1"># Compute the Fourier transforms</span>
<span class="n">xf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E1</span><span class="p">])</span> <span class="c1"># ... for each trial in E1</span>
<span class="n">yf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">E2</span><span class="p">])</span> <span class="c1"># ... and each trial in E2</span>

<span class="c1"># Compute the spectra</span>
<span class="n">Sxx</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">xf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># Spectrum of E1 trials</span>
<span class="n">Syy</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">yf</span> <span class="o">*</span> <span class="n">yf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># ... and E2 trials</span>
<span class="n">Sxy</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">yf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># ... and the cross spectrum</span>

<span class="c1"># Compute the coherence.</span>
<span class="n">cohr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Sxy</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Sxx</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Syy</span><span class="p">))</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">rfftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>                          <span class="c1"># Define a frequency axis.</span>
<span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cohr</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>                           <span class="c1"># Plot coherence vs frequency,</span>
<span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>                                <span class="c1"># ... in a chosen frequency range,</span>
<span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>                                 <span class="c1"># ... with y-axis scaled,</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">)</span>                     <span class="c1"># ... and with axes labeled.</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coherence&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coherence between two electrodes&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_5_0.png" src="_images/05_5_0.png" />
</div>
</div>
<div class="question">
<p><strong>Q:</strong> Try to read the code above. Can you see how it loads data, computes the coherence, and then plots the results?</p>
<p><strong>A:</strong> If you’ve never computed the coherence before, that’s an especially difficult question. Please continue on to learn this <strong>and more</strong>!</p>
</div>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><a class="anchor" id="background"></a></p>
<div class="section" id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h3>
<p>In most of the other modules, we focused on field data recorded from a single electrode at the scalp (EEG) or cortical (ECoG) surface. However, typical brain voltage recordings consist of multiple electrodes. For example, the standard EEG recording consists of <a href="https://en.wikipedia.org/wiki/10%E2%80%9320_system_(EEG)" rel="external">21 electrodes</a> spaced across the scalp surface, and sometimes many more. The number of electrodes utilized in invasive ECoG recordings also range from a handful of contacts to over 100 implanted electrodes. In this module, we continue our study of field data recorded from the cortical surface but now consider ECoG data recorded simultaneously from two electrodes during a task.</p>
<p><a class="reference external" href="#introduction">Return to top</a></p>
<p><a class="anchor" id="case-study-data"></a></p>
</div>
<div class="section" id="case-study-data">
<h3>Case Study Data<a class="headerlink" href="#case-study-data" title="Permalink to this headline">¶</a></h3>
<p>We conside a patient with epilepsy admitted to the hospital for <a href="https://www.ncbi.nlm.nih.gov/pubmed/25602999" rel="external">resective surgery</a>. As part of her routine clinical workup before resective surgery, numerous electrodes were implanted <a href="https://en.wikipedia.org/wiki/Electrocorticography" rel="external">directly on the cortical surface</a>. The purpose of this invasive recording procedure was to monitor and localize her seizures for eventual surgical treatment. During this recording procedure, in which electrocorticogram (ECoG) electrodes were implanted and recordings performed for one week, the patient volunteered to participate in an auditory task study administered by a collaborating researcher. The task required the patient to listen to individual phonemes through headphones and respond with a button click whenever she heard the <a href="http://www.jneurosci.org/content/30/49/16643" rel="external">phoneme</a> “ba” (the other phonemes were different, e.g., “pa,” ”ma”). The tone presentation was repeated 100 times, and her ECoG recorded (sampling rate 500 Hz) from two cortical electrodes over the auditory brain area for 1 s.</p>
<p><a class="reference external" href="#introduction">Return to top</a></p>
<p><a id="goal"></a></p>
</div>
<div class="section" id="goal">
<h3>Goal<a class="headerlink" href="#goal" title="Permalink to this headline">¶</a></h3>
<p>Our goal is to understand the coupling between the voltage activity recorded from two brain areas during the auditory task. To do so, we compute the cross-covariance and coherence between the two electrodes. These coupling measures build upon the autocovariance, Fourier transform, and spectrum.</p>
</div>
<div class="section" id="tools">
<h3>Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<p>Here you will develop an understanding for the cross-covariance and coherence measures. For the latter, we will explore and understand the Fourier transform and examine in detail the notion of phase. We also briefly discuss strategies to assess the coherence for a single trial of data.</p>
<p><a id="data-analysis"></a></p>
</div>
</div>
<div class="section" id="data-analysis">
<h2>Data Analysis<a class="headerlink" href="#data-analysis" title="Permalink to this headline">¶</a></h2>
<p><a id="visual-inspection"></a></p>
</div>
<div class="section" id="visual-inspection">
<h2>Visual inspection<a class="headerlink" href="#visual-inspection" title="Permalink to this headline">¶</a></h2>
<p>We begin our analysis by visualizing the ECoG data. To do so, let’s load the ECoG data into Python and plot the data from the first electrode (variable <code class="docutils literal notranslate"><span class="pre">E1</span></code>) and second electrode (variable <code class="docutils literal notranslate"><span class="pre">E2</span></code>) versus time (variable <code class="docutils literal notranslate"><span class="pre">t</span></code>) for the first trial.</p>
<p>We begin by loading the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="s1">&#39;matfiles/ECoG-1.mat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To understand the outcome of issuing this command, let’s examine the variable <code class="docutils literal notranslate"><span class="pre">data</span></code> now present in the workspace.  This variable is a <em>dictionary</em> variable (execute <code class="docutils literal notranslate"><span class="pre">type(data)</span></code> and the result should be <code class="docutils literal notranslate"><span class="pre">dict</span></code>). To see the <em>keys</em> of a dictionary, use the <code class="docutils literal notranslate"><span class="pre">keys()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;__header__&#39;, &#39;__version__&#39;, &#39;__globals__&#39;, &#39;E1&#39;, &#39;t&#39;, &#39;E2&#39;])
</pre></div>
</div>
</div>
</div>
<p>The keys that start and end with two underscores ( <code class="docutils literal notranslate"><span class="pre">__</span></code> ) are private and contain information about the MATLAB file. The variables that we are interested in here are <code class="docutils literal notranslate"><span class="pre">E1</span></code>, <code class="docutils literal notranslate"><span class="pre">E2</span></code>, and <code class="docutils literal notranslate"><span class="pre">t</span></code>. These correspond to the ECoG data recorded at the two electrodes (<code class="docutils literal notranslate"><span class="pre">E1</span></code> and <code class="docutils literal notranslate"><span class="pre">E2</span></code>) as well as a time axis (<code class="docutils literal notranslate"><span class="pre">t</span></code>). Let’s extract these variables from the <code class="docutils literal notranslate"><span class="pre">data</span></code> dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;E1&#39;</span><span class="p">]</span>
<span class="n">E2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="python-note">
<p>In general, a single underscore at the beginning of a variable, function or method indicates that this object should be treated as <em>private</em>. Double underscores often indicate that Python will interpret this object with some special instructions. In both cases, for what we are doing, we can usually ignore an object that starts with an underscore.</p>
</div>
<p>Our collaborator tells us that the data from each electrode are organized as a matrix with dimensions <em>(Trials, Time)</em>. Let’s examine the shape of <code class="docutils literal notranslate"><span class="pre">E1</span></code>,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E1</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(100, 500)
</pre></div>
</div>
</div>
</div>
<p>We observe that the data consist of 100 trials, each consisting of 500 data points.</p>
<div class="question">
<p><strong>Q.</strong> Is the shape of <code class="docutils literal notranslate"><span class="pre">E2</span></code> similar?  HINT: It should be!</p>
</div>
<p>Let’s now plot the data in the first trial from each electrode: <a id="fig:traces"></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">E1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>            <span class="c1"># Plot the data from the first trial of one electrode,</span>
<span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">E2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>            <span class="c1"># ... and the first trial of the other electrode.</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">);</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage [mV]&#39;</span><span class="p">);</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;traces&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;traces&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_17_0.png" src="_images/05_17_0.png" />
</div>
</div>
<p>Visual inspection of the data in this trial immediately suggests a dominant rhythmic activity occurs in each recording.</p>
<!-- #region -->
<div class="question">
<p><strong>Q.</strong> Approximate the dominant rhythmic activity in each electrode by visual inspection of the figure. A simple procedure is to count the number of peaks in each signal, then divide by the total length of the recording (in this case, 1 s). Does each electrode exhibit approximately the same rhythms? Do you observe similar results in other trials?</p>
</div><p>These techniques allow us to visualize the data one trial at a time. Doing so is often useful but can be time consuming, especially as the number of trials increases. Here we have 100 trials, and to visualize all of them in this way would require 100 plots. That’s not so bad, but there’s a better way. We can display the entire structure of the data across both time and trials as an image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                            <span class="c1"># Get the number of trials.</span>
<span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>            <span class="c1"># Make a square axis</span>
<span class="n">a</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">E1</span><span class="p">,</span>                               <span class="c1">#... and show the image,</span>
           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># ... with meaningful axes,</span>
           <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>                  <span class="c1"># ... and a nice aspect ratio.</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Trial #&#39;</span><span class="p">);</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;All trials from E1&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_20_0.png" src="_images/05_20_0.png" />
</div>
</div>
<p>The resulting image for the first electrode is shown in the figure above. Voltage (in color) is plotted as a function of time along the horizontal axis and trial number along the vertical axis. This allows us to visualize the voltage activity of the first electrode for all trials at once.</p>
<p>We notice that each trial exhibits rhythmic structure, which manifests in this image as repeating undulations of blue (low voltage), then red (high voltage) over time. We also observe variability in the alignment of these rhythms from trial to trial; from one trial to the next, the undulations appear not to align.</p>
<div class="question">
<p><strong>Q.</strong> Display an image of the activity for the second electrode and compare it to the image from the first electrode in the figure above. How do the two compare?</p>
</div><p>Visual inspection of the ECoG data allows us to draw some preliminary conclusions. First, the data appear to be rhythmic, with a particularly strong oscillation near 8 Hz. That’s interesting but not the primary research objective. We would really like to understand whether the activity at the two electrodes is related. Many techniques exist to approach this problem, but let’s begin with the most basic: visual inspection. Let’s examine the activity in the first four trials, and attempt to deduce whether a consistent relation exists between the two ECoG signals across trials.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">E1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>            <span class="c1"># Plot the data from trial j of one electrode,</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">E2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>            <span class="c1"># ... and trial j of the other electrode.</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Trial &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;imgs/traces&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_24_0.png" src="_images/05_24_0.png" />
</div>
</div>
<p>We notice in the first two trials that the ECoG activity from the two electrodes appears nearly out of phase (i.e., when the blue curve is near a peak, the red curve is near a trough). However, for the next two trials, activity from the two electrodes nearly overlaps. From this initial visual inspection of four trials, it’s difficult to conclude whether the ECoG activity at the two electrodes is interrelated; both electrodes display rhythmic activity across all trials, but the relation between these rhythms appears to change across trials: sometimes the activities overlap, and sometimes not.</p>
<div class="question">
<p><strong>Q.</strong> Repeat this analysis by examining additional trials, and by inspecting the activity images for each electrode. What conclusions can you make about the relations between the ECoG activity at the two electrodes? Are they related? Are they not related?</p>
</div><p>Although visual inspection is a useful initial tool for analyzing data, assessing the relations between two electrodes across multiple trials is a difficult task. To go further, we employ a new data analysis tool that builds from the Fourier transform: the coherence.</p>
<p><a class="reference external" href="#top">Return to top</a></p>
<!-- #endregion --><p><a id="Autocovariance-and-Cross-covariance"></a></p>
</div>
<div class="section" id="autocovariance-and-cross-covariance">
<h2>Autocovariance and Cross-covariance<a class="headerlink" href="#autocovariance-and-cross-covariance" title="Permalink to this headline">¶</a></h2>
<p>In <a href="03" rel="local">notebook 3</a>, we defined and applied the autocovariance to a single time series and found that this measure helped reveal dependent structure in the data. We could, of course, apply the autocovariance to each ECoG time series considered here. Let’s do so, with a small update to the autocovariance formula that utilizes the trial structure of these data. We define the trial-averaged autocovariance as,</p>
<div class="math notranslate nohighlight">
\[
r_{xx}\big[L\big] = \frac{1}{K} \sum_{k=1}^K \frac{1}{N} \sum_{n=1}^{N-L} (x_{n+L,k} - \bar{x}_k) (x_{n,k} - \bar{x}_k) \, ,
\]</div>
<p><span id="eq:ac" title="trial-averaged autocovariance"></span></p>
<p>where <span class="math notranslate nohighlight">\(x_{n,k}\)</span> indicates the data at time index <span class="math notranslate nohighlight">\(n\)</span> and trial <span class="math notranslate nohighlight">\(k,\)</span> and <span class="math notranslate nohighlight">\(\overline x_k\)</span> is the mean value of <span class="math notranslate nohighlight">\(x\)</span> for trial <span class="math notranslate nohighlight">\(k\)</span>. Notice that we include a new term
<span class="math notranslate nohighlight">\(\frac{1}{K}\sum_{k=1}^K\)</span>, which instructs us to sum over all trials the autocovariance computed for each trial, and then divide by the total number of trials <span class="math notranslate nohighlight">\(K\)</span>.  Let’s now compute and display the trial-averaged autocovariance for the first electrode in Python.<a id="fig:taac"></a></p>
<div class="math-note">
<p>Note: We could instead write the trial-averaged sample autocovariance because this equation uses the observed data to estimate the theoretical covariance that we would see if we kept repeating this experiment. However, this distinction is not essential to the discussion here.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>              <span class="c1"># Define the sampling interval.</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>               <span class="c1"># Define the number of trials.</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>               <span class="c1"># Define number of points in each trial.</span>
<span class="n">ac</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>       <span class="c1"># Declare empty vector for autocov.</span>

<span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">E1</span><span class="p">:</span>              <span class="c1"># For each trial,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">trial</span> <span class="o">-</span> <span class="n">trial</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># ... subtract the mean,</span>
    <span class="n">ac0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">N</span> <span class="o">*</span> <span class="n">correlate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>  <span class="c1"># ... compute autocovar,</span>
    <span class="n">ac</span> <span class="o">+=</span> <span class="n">ac0</span> <span class="o">/</span> <span class="n">K</span><span class="p">;</span>            <span class="c1"># ... and add to total, scaled by 1/K.</span>

<span class="n">lags</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>      <span class="c1"># Create a lag axis,</span>
<span class="n">plot</span><span class="p">(</span><span class="n">lags</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>           <span class="c1"># ... and plot the result.</span>
<span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lag [s]&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Autocovariance&#39;</span><span class="p">);</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Trial averaged autocovariance&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;imgs/taac&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_30_0.png" src="_images/05_30_0.png" />
</div>
</div>
<div class="question">
<p><strong>Q.</strong> Consider the results for the trial-averaged autocovariance plotted above. What do these results suggest about the rhythmic structure in these data?</p>
<p><strong>A:</strong> The trial-averaged autocovariance helps characterize the rhythmic activity at this electrode. Visual inspection of this figure reveals three large positive peaks. The largest peak occurs at a lag of 0 s, as expected; the signal matches itself at zero lag. The two other peaks occur at lags of approximately <span class="math notranslate nohighlight">\(\pm 0.125\)</span> s. These peaks reveal that the data, and a version of the data shifted by +0.125 s or -0.125 s, are a good match. Notice that a shift of <span class="math notranslate nohighlight">\(\pm 0.125\)</span> s is consistent with periodic activity of approximate frequency 1/(0.125 s) = 8 Hz. For example, imagine a sinusoid of frequency 8 Hz; if we shift the sinusoid by its period (0.125 s) and compare it to the original (unshifted) sinusoid, the match will be excellent. Our data are more complicated than a simple sinusoid, but our visual inspection of the <a class="reference external" href="#fig:traces">voltage traces</a><span class="fig"><sup>fig</sup><img src="imgs/5-1.png"></span> did reveal a dominant 8 Hz rhythm consistent with these autocovariance results.</p>
</div><div class="question">
<p><strong>Q.</strong> Repeat the analysis to compute the trial-averaged autocovariance for the second electrode. What do you find? How do the trial-averaged autocovariances for the two electrodes compare?</p>
</div><p>The trial-averaged autocovariance results for each electrode are interesting, but our primary scientific question for these data is whether dependent structure exists <em>between</em> the ECoG activity recorded from the two electrodes. In other words, are the time series recorded from the two electrodes coupled? Many tools exist to characterize coupling between time series, and in this module we focus on two such tools.</p>
<p>The first is the <strong>cross-covariance</strong>, <span class="math notranslate nohighlight">\(r_{xy}\big[L\big]\)</span>, an extension of the autocovariance to include two time series, defined as,</p>
<span id="eq:xc" title="Cross-covariance">
$$
r_{xy}\big[L\big] = \frac{1}{N} \sum_{n=1}^{N-L} (x_{n+L} - \bar{x}) (y_{n} - \bar{y}) \, ,
$$
</span>
<p>where <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are two time series with time index <span class="math notranslate nohighlight">\(n\)</span>.  Notice what we’ve done; compared to the autocovarance defined in <a href="03" rel="local">notebook 3</a>,<span class="thumb"><sup>eq</sup><img src="03/imgs/eq3-3.png"></span> the cross-covariance formula simply replaces the <span class="math notranslate nohighlight">\(x\)</span>’s in the second term in parentheses with <span class="math notranslate nohighlight">\(y\)</span>’s.</p>
<p>The intuition for understanding the cross-covariance is similar to that for the autocovariance (see <a href="03" rel="local">notebook 3</a>). To calculate the cross-covariance, we multiply <span class="math notranslate nohighlight">\(y\)</span> with <span class="math notranslate nohighlight">\(x\)</span> shifted in time by lag <span class="math notranslate nohighlight">\(L\)</span>, as illustrated here:</p>
<img src="imgs/cartoon_xc.png" style="width: 90%; max-width: 600px">
<p>Here we show a cartoon representation of the cross-covariance between two time series <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>. Data <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are visualized as one-dimensional vectors, <span class="math notranslate nohighlight">\(x\)</span> in black and <span class="math notranslate nohighlight">\(y\)</span> in blue. The cross-covariance at (b) lag 0, (c) lag 1, and (d) lag 2 requires different alignments between the two vectors. To compute the cross-covariance at each lag, we multiply the overlapping elements of the two vectors, and sum the product. Non-overlapping elements are not included in the computation.</p>
<p>The cross-covariance is large at lag <span class="math notranslate nohighlight">\(L\)</span> if the two shifted time series <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> match. If we’re interested in determining the coupling between <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>, finding these matches could be particularly useful. To illustrate an application of the cross-covariance, let’s compute it between the two electrodes during the first trial of the ECoG data: <a id="fig:xc_1"></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">E1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">E1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>  <span class="c1"># Define one time series,</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">E2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">E2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>  <span class="c1"># ... and another.</span>
<span class="n">xc</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="o">*</span><span class="n">correlate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>      <span class="c1"># ... and compute their cross covariance.</span>
<span class="n">lags</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>        <span class="c1"># Create a lag axis,</span>
<span class="n">plot</span><span class="p">(</span><span class="n">lags</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="n">xc</span><span class="p">)</span>             <span class="c1"># ... and plot the cross covariance vs lags in time.</span>

<span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>            <span class="c1"># In a nice range, with axes labelled.</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lag [s]&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cross covariance&#39;</span><span class="p">);</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cross covariance between two electrodes during the first trial&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;imgs/xc_1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_34_0.png" src="_images/05_34_0.png" />
</div>
</div>
<p>Notice that we subtract the mean from each electrode in defining <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> before computing the cross-covariance using the Python function <code class="docutils literal notranslate"><span class="pre">correlate</span></code> from the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> package. In this case, we supply the <code class="docutils literal notranslate"><span class="pre">correlate</span></code> function with three inputs, beginning with the two time series, <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>, and setting the <code class="docutils literal notranslate"><span class="pre">mode</span></code> to 2, which tells the function to compute the correlation over the entire extent both vectors.</p>
<div class="question">
<p><strong>Q.</strong> Examine the cross-covariance between the ECoG data from the two electrodes in the first trial. What do you observe? At what lags are the largest and smallest values of the cross-covariance? How do these results compare to the <a class="reference external" href="#fig:taac">trial-averaged autocovariance</a>?<span class="sup">fig<img src="imgs/taac.png"></span> How do these results compare to the voltage traces from each electrode in the <a class="reference external" href="#fig:traces">first trial</a>?<span class="sup">fig<img src="imgs/traces.png"></span></p>
</div><p>Like the <a class="reference external" href="#fig:taac">trial-averaged autocovariance for a single electrode</a>,<span class="sup">fig<img src="imgs/taac.png"></span> the <a class="reference external" href="#fig:xc_1">cross-covariance between the two ECoG electrodes</a><span class="fig"><sup>fig</sup><img src="imgs/xc_1.png"></span> in the first trial reveals periodic variations. To understand the structure of this cross-covariance, let’s return to the voltage traces from the two electrodes in this trial,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">[</span><span class="s1">&#39;traces&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_38_0.png" src="_images/05_38_0.png" />
</div>
</div>
<p>The largest peak in the cross-covariance occurs near a lag of 0.04 s. Now, imagine shifting the blue time series (corresponding to electrode 1) in this figure by 0.04 s to the left. Doing so, we find that the red and blue traces approximately match; at this lag, when one time series is positive, so is the other, and when one time series is negative, so is the other. Because of this strong match, the cross-covariance is large: i.e. the sum in <a class="reference external" href="#eq:xc">the cross-covariance equation</a><span class="thumb"><sup>eq</sup><img src='imgs/eq5-2.png'></span> at this lag involves many positive terms, so <span class="math notranslate nohighlight">\(r_{xy}\big[L\big]\)</span> is a positive number. The largest trough in the cross-covariance occurs near a lag of approximately 0.02 s. To understand this feature, imagine shifting the blue time series in the figure above by 0.02 s to the right. After this shift, the red and blue time series match, but in a different way; when one voltage trace is positive, the other is negative, and vice versa.</p>
<div class="question">
<p><strong>Q.</strong> Continue this exercise of comparing the cross-covariance with the voltage traces in the figure above. At what lags is the cross-covariance near zero? Can you explain these points in terms of shifted versions of the ECoG traces? Can you explain the repeated appearance of peaks (and troughs) at positive and negative lags in terms of shifted versions of the ECoG traces?</p>
</div><p>Let’s also define the <em>trial-averaged cross-covariance</em>. The formula is similar to the <a class="reference external" href="#eq:ac">trial-averaged autocovariance</a>:<span class="thumb"><sup>eq</sup><img src="imgs/eq5-1.png"></span></p>
<div class="math notranslate nohighlight">
\[
r_{xy}\big[L\big] = \frac{1}{K} \sum_{k=1}^K \frac{1}{N} \sum_{n=1}^{N-L} (x_{n+L,k} - \bar{x}_k) (y_{n,k} - \bar{y}_k) \, .
\]</div>
<p><a id="eq:taxc"></a>
Notice that, compared to the trial-averaged autocovariance, we have replaced the <span class="math notranslate nohighlight">\(x\)</span>’s in the last term with <span class="math notranslate nohighlight">\(y\)</span>’s to compute the trial-averaged cross-covariance.  To implement the trial-averaged cross-covariance in Python, consider the following code.</p>
<p>For reference, let’s also plot the <strong>single-trial</strong> cross-covariance for 4 trials,<br />
<a id="fig:avg_xc"></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XC</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">([</span><span class="n">K</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>    <span class="c1"># Declare empty vector for cross cov.</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>            <span class="c1"># For each trial,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">E1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">E1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># ...get data from one electrode,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">E2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">E2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># ...and the other electrode,</span>
    <span class="n">XC</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">N</span> <span class="o">*</span> <span class="n">correlate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>  <span class="c1"># ...compute cross covariance.</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
<span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lags</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">XC</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>                 <span class="c1"># Plot cross covariance vs lags in time.</span>
<span class="p">[</span><span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lags</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">XC</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>  <span class="c1"># Also, plot the single-trial cross-covariance for 4 trials</span>

<span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>             <span class="c1"># In a nice range, with axes labelled.</span>
<span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lag [s]&#39;</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trial-averaged cross covariance&#39;</span><span class="p">)</span>
<span class="n">a2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Single-trial cross-covariance&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;imgs/avg_xc&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_42_0.png" src="_images/05_42_0.png" />
</div>
</div>
<div class="python-note">
<p>You may have noticed above or in previous notebooks that we can write loops using a couple of different forms:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>for k in range(K):
    ...
</pre></div>
</div>
<p>or</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[... for k in range(K)]
</pre></div>
</div>
<p>The difference is largely stylistic, but the resulting datatype may be different. With the first method, we typically initialize an array with zeros and then replace the zeros with the value that we have computed. The result is whatever datatype we initialized. The second method will result in a list. A list can be converted to a different type or simply treated differently. In the code above, we can actually compute <code class="docutils literal notranslate"><span class="pre">XC</span></code> in a single line with the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>XC = [1 / N * correlate(x - x.mean(), y - y.mean(), &#39;full&#39;) for x, y in zip(E1, E2)]
</pre></div>
</div>
<p>At this point <code class="docutils literal notranslate"><span class="pre">XC</span></code> is a list object. We can change it to a numpy array with <code class="docutils literal notranslate"><span class="pre">XC</span> <span class="pre">=</span> <span class="pre">array(XC)</span></code>. Admittedly, there is something satisfying about accomplishing a lot in a single line. However, it is importsnt to write code that is <em>readable</em>, or easy to understand for someone who is looking at it for the first time. There may be times when a single line is more appropriate, but it is not true in every circumstance.</p>
</div><p>The implementation of the trial-averaged cross-covariance is similar to the implementation of the single-trial cross-covariance. The main difference is the inclusion of the <code class="docutils literal notranslate"><span class="pre">for</span></code> statement, which we use to compute and store the cross-covariance of each trial. We then average these results across trials using the <code class="docutils literal notranslate"><span class="pre">mean</span></code> command from the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> package. The trial-averaged cross-covariance (and example single-trial cross-covariances) are plotted in the figure above.</p>
<div class="question">
<p><strong>Q.</strong> Compare the trial-averaged cross-covariance to the example single-trial cross-covariances. What differences and similarities do you notice between the two cross-covariances?</p>
<p><strong>A.</strong> Perhaps the most striking difference between the two cross-covariances is their magnitude; the single-trial cross-covariances are much larger—approximately an order of magnitude—than the trial-averaged cross-covariance. To understand why this difference occurs, consider the impact of averaging the four example single-trial cross-covariances plotted in the figure above. At each lag, we find both positive and negtive cross-covariance values. We therefore expect that, upon averaging these values across trials, we will obtain a value near zero at each lag. In fact, that’s just what we find in the trial-averaged cross-covariance. Because the single-trial cross-covariance functions lack alignment across trials, the averaging procedure acts to cancel out the individual (large) fluctuations of each single-trial cross-covariance.</p>
<p>We may therefore conclude the following. At the single-trial level we find strong cross-covariance that is periodic with period near 0.125 s (examples in the figure aove). However, we find much weaker trial-averaged cross-covariance; the cross-covariance structure that exists at the single-trial level does not persist when averaged across trials.</p>
<p>Why are the prominent cross-covariance features in the single-trial analysis lost in the trial-averaged cross-covariance? We discuss this issue in more detail in the <a class="reference external" href="#summary">summary</a> below.</p>
</div>
<p><a class="reference external" href="#top">Return to top</a></p>
<p><a id="Trial-Averaged-Spectrum"></a></p>
</div>
<div class="section" id="trial-averaged-spectrum">
<h2>Trial-Averaged Spectrum<a class="headerlink" href="#trial-averaged-spectrum" title="Permalink to this headline">¶</a></h2>
<p>One goal of this module is to characterize the relations (if any) between the data recorded at the two ECoG electrodes. To do so, let’s review a vital tool in this characterization, the Fourier transform. We defined in <a href="03" rel="local">notebook 3</a> the Fourier transfom of a signal <span class="math notranslate nohighlight">\(x\)</span>; let’s repeat that definition here,</p>
<div class="math notranslate nohighlight">
\[
X_j = \sum_{n=1}^N x_n \exp(-2 \pi i \, f_j \, t_n) \, .
\]</div>
<p><a id="eq:ftCh5"></a></p>
<p>Remember that <span class="math notranslate nohighlight">\(x_n\)</span> is the data evaluated at time index <span class="math notranslate nohighlight">\(n\)</span>. For the ECoG data of interest here, we have 1 s of data sampled at 500 Hz; therefore <span class="math notranslate nohighlight">\(n\)</span> ranges from 1 to <span class="math notranslate nohighlight">\(N=500\)</span>, and <span class="math notranslate nohighlight">\(t_n = \mathrm{dt} \, n\)</span> denotes the discrete time steps, where <span class="math notranslate nohighlight">\(\mathrm{dt}\)</span> is the sampling interval. The discrete frequencies are <span class="math notranslate nohighlight">\(f_j = j/T\)</span>, where <span class="math notranslate nohighlight">\(j=\{-N/2+1, -N/2+2, \ldots, N/2-1, N/2\}\)</span>.  Replacing the expressions for <span class="math notranslate nohighlight">\(f_j\)</span> and <span class="math notranslate nohighlight">\(t_n\)</span> with their definitions and simplifying, we can rewrite the equation above as,</p>
<div class="math notranslate nohighlight">
\[
X_j = \sum_{n=1}^N x_n \exp(\frac{-2 \pi i}{N} j \, n) \, .
\]</div>
<p><a id="eq:ftCh5_simp"></a></p>
<p>In general, <span class="math notranslate nohighlight">\(X_j\)</span> can be a complex quantity (i.e., the Fourier transform of <span class="math notranslate nohighlight">\(x_n\)</span> can have both real and imaginary parts). We can therefore think of <span class="math notranslate nohighlight">\(X_j\)</span> as residing in the two-dimensional complex plane:</p>
<img src="imgs/ex_complex_plane.png" style="max-width: 300px;">
<p>Points in the complex plane can be specified in two coordinate systems: Cartesian coordinates (gray) or polar coordinates (orange). The <a href="https://en.wikipedia.org/wiki/Complex_plane" rel="external">complex plane</a> contains the real part (horizontal axis) and imaginary part (vertical axis) of every point.</p>
<p>As you may remember from a geometry or calculus class, we can represent a point in the plane using another coordinate system: polar coordinates. In polar coordinates, we imagine connecting each point to the origin. The resulting line has a length, called the radius or amplitude, and forms an angle with the real axis, called the phase. Like the real and complex parts, the amplitude and phase uniquely specify each point (almost …) in the complex plane. These two coordinate systems are shown for an example point in the complex plane in the figure above.</p>
<p>Using polar coordinates, we can then express the complex quantity <span class="math notranslate nohighlight">\(X_j\)</span> as,</p>
<div class="math notranslate nohighlight">
\[
X_j = A_j \exp(i \phi_j) \, ,
\]</div>
<p><a id="eq:x_polar"></a></p>
<p>where <span class="math notranslate nohighlight">\(A_j\)</span> is the amplitude and <span class="math notranslate nohighlight">\(\phi_j\)</span> is the phase at frequency index <span class="math notranslate nohighlight">\(j\)</span>.  Notice that both the amplitude and phase are functions of frequency.  Remember that, to compute the spectrum, we multiple the Fourier transform of the data by its complex conjugate, and scale the result. The spectrum of <span class="math notranslate nohighlight">\(x_n\)</span> then becomes,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
S_{xx, \, j} 	&amp;= \frac{2 \mathrm{dt}^2}{T} X_j X^\ast_j \, , \notag \\
		        &amp;= \frac{2 \mathrm{dt}^2}{T} \big(A_j \exp(i \phi_j) \big)  \big(A_j \exp(-i \phi_j) \big) \, ,
\end{align}
\end{split}\]</div>
<p><a id="eq:8" title="Spectrum"></a></p>
<p>where, to compute the complex conjugate in the second term, we replace <span class="math notranslate nohighlight">\(i\)</span> with <span class="math notranslate nohighlight">\(-i\)</span>.  The last expression simplifies rather nicely,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
S_{xx, \, j}	&amp;= \frac{2 \mathrm{dt}^2}{T} A_j^2  \exp(i \phi_j -i \phi_j) \, , \notag \\
		&amp;= \frac{2 \mathrm{dt}^2}{T} A_j^2  \exp(0) \, , \notag \\
		&amp;= \frac{2 \mathrm{dt}^2}{T} A_j^2 \, .
\end{align}
\end{split}\]</div>
<p><span id="eq:9" title="Simplified expression for the cross spectrum"></span></p>
<p>This expression provides a new, and perhaps more direct, interpretation of the spectrum as proportional to the squared amplitude of the point <span class="math notranslate nohighlight">\(X_j\)</span> in the complex plane. We can extend this simplified expression in one additional way to make explicit the trial structure of the ECoG data analyzed here. Because we possess multiple trials, and we assume that each trial represents an instantiation of the same underlying process, we average the spectra across trials to compute the <em>trial-averaged spectrum</em>,</p>
<div class="math notranslate nohighlight">
\[
&lt;S_{xx, \, j}&gt; = \frac{2 \mathrm{dt}^2}{T} \frac{1}{K} \sum_{k=1}^K A_{j,k}^2 \, ,
\tag{Trial-averaged spectrum}
\]</div>
<p><span title="Trial-averaged spectrum"></span></p>
<p>where <span class="math notranslate nohighlight">\(k\)</span> indicates the trial number, <span class="math notranslate nohighlight">\(K\)</span> the total number of trials, and <span class="math notranslate nohighlight">\(A_{j,k}\)</span> the amplitude of the signal at frequency index <span class="math notranslate nohighlight">\(j\)</span> and trial index <span class="math notranslate nohighlight">\(k\)</span>.  Notice how we implement the trial averaging: we simply average the squared amplitude at frequency index <span class="math notranslate nohighlight">\(j\)</span> across the <span class="math notranslate nohighlight">\(K\)</span> trials.  We use the angular brackets (<span class="math notranslate nohighlight">\(&lt; \, &gt;\)</span>) to denote that the spectrum (<span class="math notranslate nohighlight">\(S_{xx, \, j}\)</span>) has been averaged across trials. We can compute the trial-averaged spectrum in Python,</p>
<p><a id="fig:trial_avg_spectrum"></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                                     <span class="c1"># Get the total time of the recording.</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                               <span class="c1"># Determine the number of sample points per trial</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">T</span>                         <span class="c1"># Compute the scaling constant</span>

<span class="c1"># Compute the Fourier transform for each trial</span>
<span class="n">xf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E1</span><span class="p">])</span>  <span class="c1"># ... in E1</span>
<span class="n">yf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">E2</span><span class="p">])</span>  <span class="c1"># ... and in E2</span>

<span class="c1"># Compute the spectra</span>
<span class="n">Sxx</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">xf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>                <span class="c1"># Spectrum of E1 trials</span>
<span class="n">Syy</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">yf</span> <span class="o">*</span> <span class="n">yf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>                <span class="c1"># ... and E2 trials</span>
<span class="n">Sxy</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">yf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>                <span class="c1"># ... and the cross spectrum</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">rfftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>                           <span class="c1"># Define the frequency axis</span>

<span class="c1"># Plot the average spectrum over trials in decibels vs frequency</span>
<span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">log10</span><span class="p">(</span><span class="n">Sxx</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trial-averaged spectrum&#39;</span><span class="p">)</span>  
<span class="c1"># ... and the spectrum from the first trial for reference</span>
<span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">log10</span><span class="p">(</span><span class="n">Sxx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Single-trial spectrum&#39;</span><span class="p">)</span>  

<span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>                                <span class="c1"># ... in select frequency range,</span>
<span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>                                <span class="c1"># ... in select power range,</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">)</span>                      <span class="c1"># ... with axes labelled.</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power [ mV^2/Hz]&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Trial-averaged spectrum&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">()</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;imgs/trial_avg_spectrum&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_48_0.png" src="_images/05_48_0.png" />
</div>
</div>
<div class="question">
<p><strong>Q:</strong> Are the terms frequency resolution, Nyquist frequency, and decibel familiar to you? Can you define each in words and equations?</p>
<p><strong>A:</strong> If not, we recommend reviewing the case study in <a href="03" rel="local">notebook 3</a>.</p>
</div><p>The resulting trial-averaged spectrum is shown in the figure above. Compared to the example spectrum from a single trial, the variability is greatly reduced. By reducing the variability in this way, interesting structure in the data may become more apparent.</p>
<div class="question">
<p><strong>Q.</strong>  Upon examining the trial-averaged spectrum from one electrode, what additional conclusions can you now make about the data beyond visual inspection of the voltage traces? Repeat this computation of the trial-averaged spectrum for the second electrode. What do you find?  <em>Hint</em>: The 8 Hz peak is obvious and consistent with our visual inspection of the data. Do you notice any other (smaller) peaks in the trial-averaged spectrum?</p>
</div><p><a class="reference external" href="#introduction">Return to top</a></p>
<p><a class="anchor" id="sec:coherence"></a></p>
</div>
<div class="section" id="introduction-to-the-coherence">
<h2>Introduction to the Coherence<a class="headerlink" href="#introduction-to-the-coherence" title="Permalink to this headline">¶</a></h2>
<p>Coherence is a measure of association between two time series. Briefly:</p>
<div class="math-note">
<p>Two signals are coherent at some frequency if there exists a constant phase relation between them at this frequency.</p>
</div>
<p>To compute the coherence, we use the <a class="reference external" href="#eq:9">simplified expression for the spectrum</a><span class="thumb"><sup>eq</sup><img src="imgs/eq5-9.png"></span> and an additional term, the cross-spectrum.</p>
<p>Consider two signals <span class="math notranslate nohighlight">\(x_{n,k}\)</span> and <span class="math notranslate nohighlight">\(y_{n,k}\)</span>, with time index <span class="math notranslate nohighlight">\(n\)</span> and trial index <span class="math notranslate nohighlight">\(k\)</span>. These signals have corresponding Fourier transforms <span class="math notranslate nohighlight">\(X_{j,k}\)</span> and <span class="math notranslate nohighlight">\(Y_{j,k}\)</span>. Then the <em>trial-averaged cross-spectrum</em> between these two signals is</p>
<div class="math notranslate nohighlight">
\[
&lt;S_{xy,\, j}&gt; = \frac{2 \mathrm{dt}^2}{T} \frac{1}{K}\sum_{k=1}^K X_{j,k} Y^*_{j,k} \, ,
\]</div>
<p><span id="eq:10" title="Trial averaged cross-spectrum"></span></p>
<p>where compared to <a class="reference external" href="#eq:8">the spectrum</a><span class="thumb"><sup>eq</sup><img src="imgs/eq5-8.png"></span> we replace <span class="math notranslate nohighlight">\(X^*_j\)</span> with <span class="math notranslate nohighlight">\(Y^*_j\)</span> and include the average over the trial index <span class="math notranslate nohighlight">\(k\)</span>.  Let’s modify and clean up this expression by using polar coordinates.  To do so, we’ll first define,</p>
<div class="math notranslate nohighlight">
\[
Y_{j,k} = B_{j,k} \exp(i \, \theta_{j,k}) \, ,
\]</div>
<p>where <span class="math notranslate nohighlight">\(B_{j,k}\)</span> is the amplitude and <span class="math notranslate nohighlight">\(\theta_{j,k}\)</span> is the phase at frequency index <span class="math notranslate nohighlight">\(j\)</span> and trial index <span class="math notranslate nohighlight">\(k\)</span> for the signal <span class="math notranslate nohighlight">\(y_{n,k}\)</span>. A similar expression exists for <span class="math notranslate nohighlight">\(X_{j,k}\)</span>, with amplitude <span class="math notranslate nohighlight">\(A_{j,k}\)</span> and phase <span class="math notranslate nohighlight">\(\phi_{j,k}\)</span>. Then, replacing <span class="math notranslate nohighlight">\(X_{j,k}\)</span> and <span class="math notranslate nohighlight">\(Y^*_{j,k}\)</span> in <a class="reference external" href="#eq:9">the trial-averaged cross-spectrum</a><span class="sup">eq<img src="imgs/eq5-9.png"></span> with their polar coordinate expressions, we find,</p>
<div class="math notranslate nohighlight">
\[
&lt;S_{xy,\, j}&gt; = \frac{2 \mathrm{dt}^2}{T} \frac{1}{K} \sum_{k=1}^K A_{j,k} B_{j,k} \exp \big( i \Phi_{j,k} \big) \, ,
\tag{Cross spectrum}
\]</div>
<p><span id="eq:cross_spectrum" title="Cross spectrum"></span></p>
<p>where we have defined the <em>phase difference</em> between the two signals as <span class="math notranslate nohighlight">\(\Phi_{j,k} = \phi_{j,k} - \theta_{j,k}\)</span>. This equation is the trial-averaged cross spectrum of the two signals <span class="math notranslate nohighlight">\(x_{n,k}\)</span> and <span class="math notranslate nohighlight">\(y_{n,k}\)</span>.  We note that the trial-averaged cross spectrum (<span class="math notranslate nohighlight">\(&lt;S_{xy,\, j}&gt;\)</span>) can be complex (i.e., may have nonzero real and imaginary parts).</p>
<p>At last we define the <strong>coherence</strong>,</p>
<div class="math notranslate nohighlight">
\[
\kappa_{xy,\, j} = \frac{ \mid &lt;S_{xy,\, j}&gt; \mid }{ \sqrt{&lt;S_{xx, \, j}&gt;} \sqrt{&lt;S_{yy, \, j}&gt;}} \, ,
\tag{Coherence}
\]</div>
<p><span id="eq:cohr" title="Coherence"></span></p>
<p>where <span class="math notranslate nohighlight">\(\mid &lt;S_{xy,\, j}&gt; \mid\)</span> indicates the magnitude of the trial-averaged cross spectrum.  In words, the coherence is the magnitude of the trial-averaged cross spectrum between the two signals at frequency index <span class="math notranslate nohighlight">\(j\)</span> divided by the magnitude of the trial-averaged spectrum of each signal at frequency index <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>To further our understanding of the mathematical expression of the coherence, let’s replace the trial-averaged spectra in the numerator and denominator with their corresponding expressions in polar coordinates,</p>
<div class="math notranslate nohighlight">
\[
\kappa_{xy,\, j} = \frac { \biggr\lvert \sum\limits_{k=1}^K A_{j,k} B_{j,k} \exp \big( i \Phi_{j,k} \big) \biggr\rvert }
			       { \sqrt{\sum\limits_{k=1}^K A_{j,k}^2} \,  \sqrt{\sum\limits_{m=1}^K B_{j,m}^2} }
\]</div>
<p><span id="eq:cohr_ang" title="Coherence in polar coordinates"></span></p>
<p>This expression is complicated.  So, to gain some intuition for the behavior of <span class="math notranslate nohighlight">\(\kappa_{xy,\, j}\)</span>, let’s make the simplifying assumption that at each frequency the amplitude is identical for both signals and all trials, that is, <span class="math notranslate nohighlight">\(A_{j,k} = B_{j,k} = C_j\)</span>.  Notice that, in using only the expression <span class="math notranslate nohighlight">\(C_j\)</span> for the amplitude, we’ve eliminated the trial index <span class="math notranslate nohighlight">\(k\)</span>, and only preserved the frequency index <span class="math notranslate nohighlight">\(j\)</span>. With this simplifying assumption, our expression for the coherence becomes,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
\kappa_{xy,\, j} &amp;= \frac { \biggr\lvert \sum\limits_{k=1}^K C_j \, C_j \exp \big( i \Phi_{j,k} \big) \biggr\rvert }
			         { \sqrt{\sum\limits_{k=1}^K C_j^2}  \sqrt{\sum\limits_{m=1}^K C_j^2} } \, , \notag \\
		    &amp;= \frac{ C_j^2 }{ C_j^2 } \frac{\biggr\lvert \sum\limits_{k=1}^K \exp \big( i \Phi_{j,k} \big) \biggr\rvert}{\sqrt{\sum\limits_{k=1}^K 1}  \sqrt{\sum\limits_{m=1}^K 1} } \, , \notag \\
		    &amp;= \frac{ 1 }{ K }\biggr\lvert \sum_{k=1}^K \exp \big( i \Phi_{j,k} \big) \biggr\rvert \, .
\end{align}
\end{split}\]</div>
<p><span id="eq:cohr_simp" title="Coherence (simplified)"></span></p>
<p>Under the simplifying assumption that the amplitude is identical at each frequency for both signals and all trials, the coherence simplifies to the last equation in the expression above. In this special case, the expression for the coherence only involves the phase difference between the two signals averaged across trials; the amplitudes in the numerator and denominator have canceled out.</p>
<p>Now, let’s interpret the simplified expression for the coherence. To do so, we consider two scenarios.</p>
<p><a id="Simple_Scenario_1"></a></p>
<div class="section" id="simple-scenario-1-phases-align-across-trials">
<h3>Simple Scenario 1:  Phases align across trials<a class="headerlink" href="#simple-scenario-1-phases-align-across-trials" title="Permalink to this headline">¶</a></h3>
<p>First, we assume that at a specific frequency index <span class="math notranslate nohighlight">\(j\)</span>, the two signals possess a <em>constant</em> phase difference across trials. Under this assumption, the phase difference in the first trial (<span class="math notranslate nohighlight">\(\Phi_{j,1}\)</span>) equals the phase difference in the second trial (<span class="math notranslate nohighlight">\(\Phi_{j,2}\)</span>), which equals the phase difference in the third trial (<span class="math notranslate nohighlight">\(\Phi_{j,3}\)</span>), and so on for all trials.  To denote this equivalence in the phase difference across trials, let’s replace the symbol for the phase difference <span class="math notranslate nohighlight">\(\Phi_{j,k}\)</span> with <span class="math notranslate nohighlight">\(\Phi_{j,0}\)</span>; here, we have replaced the subscript <span class="math notranslate nohighlight">\(k\)</span> with the subscript <span class="math notranslate nohighlight">\(0\)</span> to remind ourselves that the phase difference does not depend upon the choice of trial. Now consider the expression:</p>
<div class="math notranslate nohighlight">
\[
\exp \big( i \Phi_{j,0} \big) \, . \notag
\]</div>
<p>This term defines a point in the complex plane with amplitude 1, which we can visualize as a vector leaving the origin at angle <span class="math notranslate nohighlight">\(\Phi_{j,0}\)</span> to the real axis. Consider, for example, the leftmost plot in the figure below:
<img src="imgs/ex_complex_plane_coherence_a.png"></img></p>
<p>In this cartoon illustration of the complex plane, we plot the phase difference for each trial (orange arrow). In this case, the phase difference is the same across all trials.</p>
<p>The summation of these terms across trials then becomes,</p>
<div class="math notranslate nohighlight">
\[
\sum_{k=1}^K \exp \big( i \Phi_{j,0} \big) \, . \notag
\]</div>
<p>This expression defines a sum of vectors in the complex plane, each of radius 1 (indicated by the blue circle in the figure). Because the phase difference is the same for each trial, these vectors point in the same direction for each trial. Then by summing up these vectors end to end across trials, we produce a long vector in the complex plane that terminates far from the origin, as shown in the righmost panel of the figure above.</p>
<div class="question">
<p><strong>Q:</strong> How long is the summed vector in this case?</p>
<p><strong>A:</strong> We add <span class="math notranslate nohighlight">\(K\)</span> vectors (one for each trial) each of length 1, and each pointing in the same direction (<span class="math notranslate nohighlight">\(\Phi_{j,0}\)</span>).  So the total length of the vector (i.e., the total distance from the origin to the termination point of the summed vector) is <span class="math notranslate nohighlight">\(K\)</span>.</p>
</div><p>The <a class="reference external" href="#eq:cohr_simp">coherence</a><span class="thumb"><sup>eq</sup><img src="imgs/eqcohr_simp.png"></span> is this vector length, divided by <span class="math notranslate nohighlight">\(K\)</span>, so we conclude in this case that,</p>
<div class="math notranslate nohighlight">
\[
\kappa_{xy,\, j} = 1 \, , \notag
\]</div>
<p>which indicates strong coherence between the two signals.  The strong coherence in this case results from the constant phase relationship between the two signals across trials at frequency index <span class="math notranslate nohighlight">\(j\)</span>.</p>
<div class="question">
<p><strong>Q:</strong> Does the conclusion <span class="math notranslate nohighlight">\(\kappa_{xy,\, j} = 1\)</span> depend upon the value of the phase difference <span class="math notranslate nohighlight">\(\Phi_{j,0}\)</span>?  For example, does this result require that the phase difference between the two signals in each trial (<span class="math notranslate nohighlight">\(\Phi_{j,0}\)</span>) equal <span class="math notranslate nohighlight">\(0\)</span>, or <span class="math notranslate nohighlight">\(\pi/4\)</span>, or <span class="math notranslate nohighlight">\(\pi\)</span>?</p>
</div>
<p><a class="reference external" href="#top">Return to top</a></p>
</div>
<div class="section" id="simple-scenario-2-phases-are-random-across-trials">
<h3>Simple Scenario 2: Phases are random across trials<a class="headerlink" href="#simple-scenario-2-phases-are-random-across-trials" title="Permalink to this headline">¶</a></h3>
<p><a id="Simple_Scenario_2"></a></p>
<p>As a second scenario, consider another specific frequency <span class="math notranslate nohighlight">\(j\)</span> in which the two signals have a random phase difference in each trial. In this case, the phase difference can assume any value between <span class="math notranslate nohighlight">\(0\)</span> and <span class="math notranslate nohighlight">\(2\pi\)</span> for each trial. To visualize this, let’s imagine the phase differences in the complex plane; in this scenario, the vectors point in different (random) directions from trial to trial:</p>
<p><img src="imgs/ex_complex_plane_coherence_b.png"></img></p>
<div class="question">
<p><strong>Q:</strong> Consider the sum of these vectors end to end in the complex plane, plotted in the rightmost panel of the figure above. What is the approximate length of this summed vector across trials?</p>
<p><strong>A:</strong> We expect the length of this vector to be small. Because the angles lack organization from trial to trial, the vectors are equally likely to point in any direction. Therefore, when we sum these vectors across trials, the length fails to accumulate in any particular direction.</p>
</div><p>Under the simplifying assumption that the amplitude is identical at this frequency for both signals and all trials, the <a class="reference external" href="#eq:cohr_simp">coherence</a><span class="thumb"><sup>eq</sup><img src="imgs/eqcohr_simp.png"></span> is this summed vector length, divided by <span class="math notranslate nohighlight">\(K\)</span>. Our visual inspection of the cartoon in the figure above (rightmost panel) suggests that this summed vector length will be small. Therefore, for this scenario we conclude that,</p>
<div class="math notranslate nohighlight">
\[
\kappa_{xy,\, j} \approx 0 \, , \notag
\]</div>
<p>which indicates weak coherence between the two signals.  The weak coherence in this case results from the random phase relationship over trials between the two signals.</p>
<p><a id="Summary_of_the_coherence"></a></p>
</div>
</div>
<div class="section" id="summary-of-the-coherence">
<h2>Summary of the coherence<a class="headerlink" href="#summary-of-the-coherence" title="Permalink to this headline">¶</a></h2>
<p>These two examples illustrate in simplified scenarios the behavior of the coherence. To summarize, the <a class="reference external" href="#eq:cohr">coherence</a><span class="thumb"><sup>eq</sup><img src="imgs/eqcohr.png"></span> is a measure of the relationship between <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> at the same frequency.  The coherence ranges between 0 and 1,</p>
<div class="math notranslate nohighlight">
\[
0 \leq \kappa_{xy,\, j}  \leq 1 \, , \notag
\]</div>
<p>in which:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(0\)</span> indicates no coherence between signals <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> at frequency index <span class="math notranslate nohighlight">\(j\)</span>, and</p></li>
<li><p>1 indicates strong strong coherence between signals <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> at frequency index <span class="math notranslate nohighlight">\(j\)</span>.</p></li>
</ul>
<div class="python-note">
<p>The coherence is a measure of the phase consistency between two signals at frequency index <span class="math notranslate nohighlight">\(j\)</span> across trials.</p>
</div><p>We note that because computing the coherence requires the Fourier transform, the notions of frequency resolution and Nyquist frequency are identical to those for the spectrum. In other words, the frequency resolution of the coherence is <span class="math notranslate nohighlight">\(1/T\)</span>, and the Nyquist frequency is half of the sampling frequency; see <a href="03" rel="local">notebook 3</a> for details.</p>
<div class="question">
<p><strong>Q.</strong> What are the units of the coherence?
Hint: Consider <a href="#eq:cohr" class="thumb">this equation<img src="imgs/eqcohr.png"></a> for coherence and the units of the terms in the numerator and denominator. You should find that the coherence is unitless.</p>
</div>
<p><a class="reference external" href="#introduction">Return to top</a></p>
<hr class="docutils" />
<p><a id="cc_and_cs"></a></p>
</div>
<div class="section" id="cross-covariance-and-cross-spectrum">
<h2>Cross-Covariance and Cross-Spectrum<a class="headerlink" href="#cross-covariance-and-cross-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Although we defined the <a class="reference external" href="#eq:9">cross-spectrum</a><span class="thumb"><sup>eq</sup><img src="imgs/eq5-9.png"></span> and used it to define the <a class="reference external" href="#eq:cohr">coherence</a><span class="thumb"><sup>eq</sup><img src="imgs/eqcohr.png"></span>, the cross-spectrum may appear somewhat unmotivated. Fortunately, there is additional insight to be gained. We show in a <a href="03#supplements" rel="local">supplement</a> at the end of notebook 3 that the spectrum is the Fourier transform of the autocovariance. Conceptually, the spectrum and autocovariance provide a frequency domain and time domain measure of a signal’s rhythms, respectively. In the same way, the cross-spectrum and cross-covariance are partners.</p>
<div class="math-note">
<p>The cross-spectrum is the Fourier transform of the cross-covariance.</p>
</div><p>The cross-spectrum and cross-covariance form a Fourier transform pair. The cross-spectrum is a frequency domain measure of coupling, while the cross-covariance is a time domain measure of coupling. To move back and forth between these two measures, we use the Fourier transform. In practice, we rarely examine the cross-spectrum directly; it’s a complex quantity and so requires two dimensions (i.e., the complex plane) to visualize. However, the cross-spectrum is fundamental to the coherence, so in that sense it’s an important actor in the analysis.</p>
<p><a id="computing_coherence"></a></p>
</div>
<div class="section" id="computing-the-coherence">
<h2>Computing the Coherence<a class="headerlink" href="#computing-the-coherence" title="Permalink to this headline">¶</a></h2>
<p>With that introduction, we are now equipped to compute the coherence. We expect the coherence to reveal the frequencies at which the two ECoG signals exhibit a constant phase relation across trials.</p>
<div class="question">
<p><strong>Q.</strong> Before we compute the coherence, hypothesize whether you expect to observe coherence between the two ECoG signals. If so, at what frequencies? Your hypothesis should be based on the previous visual analysis and spectral analysis of these data (see, for example, <a href="#fig:traces" class="fig">this figure<img src="imgs/traces.png"></a> and <a href="#fig:trial_avg_spectrum" class="fig">this figure<img src="imgs/trial_avg_spectrum.png"></a>).</p>
</div><div class="question">
<p><strong>Q.</strong> To plot the coherence versus frequency, we must identify the frequency resolution and Nyquist frequency appropriate for the analysis of the ECoG data. What are they?</p>
</div><p>There are a variety of alternatives to compute the coherence. To start, let’s compute the coherence by hand. The reason for doing so is that we can implement the preceding mathematical expressions and in that way gain more understanding of their features. Here’s the Python code<a id="fig:cohr"></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the Fourier transforms</span>
<span class="n">xf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E1</span><span class="p">])</span>  <span class="c1"># ... for each trial in E1</span>
<span class="n">yf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">E2</span><span class="p">])</span>  <span class="c1"># ... and each trial in E2</span>

<span class="c1"># Compute the spectra</span>
<span class="n">Sxx</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">xf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Spectrum of E1 trials</span>
<span class="n">Syy</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">yf</span> <span class="o">*</span> <span class="n">yf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># ... and E2 trials</span>
<span class="n">Sxy</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">yf</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># ... and the cross spectrum</span>

<span class="c1"># Compute the coherence.</span>
<span class="n">cohr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Sxy</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Sxx</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Syy</span><span class="p">))</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">rfftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>                     <span class="c1"># Define a frequency axis.</span>
<span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cohr</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>                      <span class="c1"># Plot coherence vs frequency,</span>
<span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>                           <span class="c1"># ... in a chosen frequency range,</span>
<span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>                            <span class="c1"># ... with y-axis scaled,</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">)</span>                <span class="c1"># ... and with axes labeled.</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coherence&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coherence between two electrodes&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_73_0.png" src="_images/05_73_0.png" />
</div>
</div>
<div class="question">
<p><strong>Q.</strong> That’s quite a bit of code. Look through it line by line, and confirm that each step makes sense. Can you identify the calculation of the cross-spectrum? of the trial averaging?</p>
</div><div class="question">
<p><strong>Q:</strong> Consider the coherence between the two ECoG electrodes plotted in the figure above. At what frequencies do strong coherences appear? How do these frequencies compare to the trial-averaged spectra, shown for one electrode in <span class="fig"><a class="reference external" href="#fig:trial_avg_spectrum">this figure</a><img src="imgs/trial_avg_spectrum.png"></span>?</p>
<p><strong>A:</strong> The coherence measures the phase consistency at a chosen frequency between two signals across trials. For the ECoG data, both electrodes possess trial-averaged spectra with similar features: a large peak near 8 Hz and a smaller peak near 24 Hz. However, the coherence between the two ECoG signals reveals a peak only at 24 Hz. We conclude that the two ECoG signals both exhibit a dominant oscillation at 8 Hz, yet this rhythm is not coherent across trials; only the smaller-amplitude rhythm at 24 Hz is coherent between the two electrodes.</p>
</div><p><a id="Visualizing_the_Phase_Difference"></a></p>
</div>
<div class="section" id="visualizing-the-phase-difference-across-trials">
<h2>Visualizing the Phase Difference across Trials<a class="headerlink" href="#visualizing-the-phase-difference-across-trials" title="Permalink to this headline">¶</a></h2>
<p>The coherence results suggest for the two ECoG recordings a constant phase relation across trials at 24 Hz and a random phase relation across trials at 8 Hz. To further explore these relations, let’s visualize the distribution of phase differences at the two frequencies, as implemented in the following Python code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j8</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">==</span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>       <span class="c1"># Determine index j for frequency 8 Hz.</span>
<span class="n">j24</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">==</span><span class="mi">24</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># Determine index j for frequency 24 Hz.</span>

<span class="n">phi8</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>              <span class="c1"># Variables to hold phase differences.</span>
<span class="n">phi24</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>           <span class="c1"># For each trial, compute the cross spectrum. </span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">E1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">E1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>  <span class="c1"># Get the data from each electrode,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">E2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">E2</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
    <span class="n">xf</span> <span class="o">=</span> <span class="n">rfft</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>   <span class="c1"># ... compute the Fourier transform,</span>
    <span class="n">yf</span> <span class="o">=</span> <span class="n">rfft</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">Sxy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">xf</span> <span class="o">*</span> <span class="n">conj</span><span class="p">(</span><span class="n">yf</span><span class="p">))</span>  <span class="c1"># ... and the cross-spectrum,</span>
    <span class="n">phi8</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">Sxy</span><span class="p">[</span><span class="n">j8</span><span class="p">])</span> <span class="c1"># ... and the phases.</span>
    <span class="n">phi24</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">Sxy</span><span class="p">[</span><span class="n">j24</span><span class="p">])</span>
                             <span class="c1"># Plot the distributions of phases.</span>
<span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">phi8</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="p">])</span>
<span class="n">a2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">phi24</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="p">])</span>

<span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>                <span class="c1"># Set y-axis and label axes.</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase&#39;</span><span class="p">);</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Angles at 8 Hz&#39;</span><span class="p">)</span>

<span class="n">a2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Angles at 24 Hz&#39;</span><span class="p">)</span>
<span class="n">a2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_78_0.png" src="_images/05_78_0.png" />
</div>
</div>
<p>Again, we’re encountering quite a bit of Python code. Fortunately, large chunks of this code are familiar. We reuse useful quantities, like the number of trials (<code class="docutils literal notranslate"><span class="pre">K</span></code>) and the frequency axis (<code class="docutils literal notranslate"><span class="pre">f</span></code>). Then, within the frequency axis variable (<code class="docutils literal notranslate"><span class="pre">f</span></code>), we use the function <code class="docutils literal notranslate"><span class="pre">where</span></code> to identify the indices corresponding to a frequency of 8 Hz and a frequency of 24 Hz. For each trial, we then compute the cross-spectrum (<code class="docutils literal notranslate"><span class="pre">Sxy</span></code>). The cross-spectrum is a complex quantity at each frequency, and we identify the angle in the complex plane corresponding to the frequencies 8 Hz and 24 Hz using the Python function <code class="docutils literal notranslate"><span class="pre">angle</span></code>. We store these results in two vectors, <code class="docutils literal notranslate"><span class="pre">phi8</span></code> and <code class="docutils literal notranslate"><span class="pre">phi24</span></code>.</p>
<p>To summarize the results, we plot a histogram of the phase differences. We divide the phase axis into 20 bins of equal size from 0 to 2$\pi$ radians, or equivalently, 0 to 360 degrees. At 8 Hz, we observe that phase differences appear in all angular intervals; notice that the number of phase differences located in each angular interval remains small, typically less than 10. At 24 Hz, the angular differences concentrate near 0 degrees; all of the angles lie between  approximately 60 and 60 degrees. This visualization is consistent with the strong coherence at 24 Hz, indicative of a consistent phase difference across trials between the two electrodes.</p>
<div class="question">
<p><strong>Q.</strong> Compute and display the distribution of phase differences at other frequencies. What do you find? Are these results consistent with the <a class="reference external" href="#fig:cohr">coherence</a><span class="fig"><sup>fig</sup><img src="imgs/cohr.png"></span>?</p>
</div><p><a id="single_trial_coherence"></a></p>
</div>
<div class="section" id="single-trial-coherence">
<h2>Single-Trial Coherence<a class="headerlink" href="#single-trial-coherence" title="Permalink to this headline">¶</a></h2>
<p>We have emphasized that coherence is a measure of phase consistency between two signals at some frequency <em>across trials</em>. This type of analysis is appropriate in many instances in which data are collected in a trial structure. However, we might also be interested in computing the coherence between two signals recorded in a single observation or trial.</p>
<div class="question">
<p><strong>Q:</strong> Is it possible? Can we compute the coherence between two signals for a single trial?</p>
</div><p>To address this question, consider the <a class="reference external" href="#eq:cohr_ang">equation for the coherence written in polar coordinates</a><span class="thumb"><sup>eq</sup><img src="imgs/eqcohr_ang.png"></span>.  Remember that, in writing this equation, we have made no assumptions about the data;  instead, all we have done is express the complex quantities in polar coordinates.  Now consider this equation for the case in which we possess only one trial, so that <span class="math notranslate nohighlight">\(K=1\)</span>.  Then,</p>
<div class="math notranslate nohighlight">
\[
\kappa_{xy,\, j} = \frac { \biggr\lvert A_{j,1} B_{j,1} \exp \big( i \Phi_{j,k} \big) \biggr\rvert }
			       { \sqrt{A_{j,1}^2}  \sqrt{B_{j,1}^2} }
		     = \biggr\lvert \exp \big( i \Phi_{j,k} \big) \biggr\rvert = 1 \, .
\]</div>
<p>So, we find here perfect coherence (<span class="math notranslate nohighlight">\(\kappa_{xy,\, j}=1\)</span>) for any choice of signals <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> and for any frequency (index <span class="math notranslate nohighlight">\(j\)</span>).  For example, we could choose <span class="math notranslate nohighlight">\(x\)</span> to be the price of a publicly traded stock (e.g., GE) and <span class="math notranslate nohighlight">\(y\)</span> to be an ECoG recording, both sampled at 500 Hz for 1 s.  Even in this case, we will find perfect coherence between the two signals.</p>
<div class="question">
<p><strong>Q:</strong> Can we use an ECoG signal to predict the stock price of GE? If so, then we’re rich! How can any two arbitrary signals be perfectly coherent at all frequencies?</p>
</div><p>The answer is that the coherence measure requires a trial structure. Recall that the coherence measures the phase consistency between two signals <em>across trials</em>. If only one trial is observed, then the two signals are trivially coherent; the two signals have some phase difference between 0 and 2$\pi$ and because we have no other trials with which to compare this difference, the two signals are “coherent.”</p>
<p>But what if we only collect one trial of data? We can still attempt to compute the coherence in (at least) two ways. First, we could divide the single trial of data into smaller intervals and then treat each interval as a trial. This approach can be effective if we believe the phase relation persists in time, and if we possess a long enough recording. Note that by dividing the data into smaller intervals, we impact the frequency resolution.</p>
<div class="question">
<p><strong>Q:</strong> Imagine we collect 10 s of ECoG data (sampling frequency 500 Hz) from two electrodes and would like to compute the coherence. To do so, we divide the data into ten nonoverlapping 1 s intervals, and treat each interval as a trial to compute the coherence. What is the frequency resolution of the coherence? If instead we divide the data into 100 nonoverlapping frequency intervals, what is the frequency resolution? In both cases, what is the Nyquist frequency?</p>
</div><p>A second approach to compute the coherence from a single trial of data is to use the <a href="https://en.wikipedia.org/wiki/Multitaper" rel="external">multitaper method</a>. In this case, each taper acts like a trial. Therefore, to acquire more trials for an accurate estimate of the coherence, we include more tapers. But, by increasing the number of tapers, we worsen the frequency resolution. Because the ECoG data of interest here consist of multiple trials, we do not focus on measures of single-trial coherence.</p>
</div>
<div class="section" id="relation-between-statistical-modeling-and-coherence">
<h2>Relation between Statistical Modeling and Coherence<a class="headerlink" href="#relation-between-statistical-modeling-and-coherence" title="Permalink to this headline">¶</a></h2>
<p><a id="Relation_between_Statistical_Modeling_and_Coherence"></a></p>
<p>Before concluding the discussion of coherence, let’s briefly consider a complementary statistical modeling approach. In developing this statistical model, our goal is to capture the (linear) relation between two signals <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> observed simultaneously for multiple trials. We begin by proposing a statistical model that predicts one signal (<span class="math notranslate nohighlight">\(y\)</span>) as a linear function of the other (<span class="math notranslate nohighlight">\(x\)</span>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
y_n	&amp;= \sum\limits_{m = -\infty}^{\infty} \beta_m x_{n-m} + \epsilon_n \, , \\
	&amp;= (\beta \star x)\big[n\big] + \epsilon_n \, ,
\end{align*}
\end{split}\]</div>
<p>where we express the predicted signal (<span class="math notranslate nohighlight">\(y_n\)</span>) as a function of <span class="math notranslate nohighlight">\(x_n\)</span>, coefficients <span class="math notranslate nohighlight">\(\beta_m\)</span>, and a Gaussian noise term <span class="math notranslate nohighlight">\(\epsilon_n\)</span>, and where <span class="math notranslate nohighlight">\(n\)</span> is a discrete time index.  Notice that, in the first equation, the summation limits indicate that the predicted signal at time index <span class="math notranslate nohighlight">\(n\)</span> may depend on <span class="math notranslate nohighlight">\(x\)</span> at any past or future time.  The second equality above expresses the summed product of <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(x\)</span> as their convolution.  Taking the Fourier transform of both sides of this equation, and noting that convolution in the time domain is equivalent to multiplication in the frequency domain, we find,</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
Y_j	&amp;= \gamma_j X_j + \Upsilon_j \, ,
\end{align*}
\]</div>
<p>where <span class="math notranslate nohighlight">\(Y_j\)</span> is the Fourier transform of <span class="math notranslate nohighlight">\(y_n\)</span>,
<span class="math notranslate nohighlight">\(\gamma_j\)</span> is the Fourier transform of <span class="math notranslate nohighlight">\(\beta_n\)</span>,
<span class="math notranslate nohighlight">\(X_j\)</span> is the Fourier transform of <span class="math notranslate nohighlight">\(x_n\)</span>,
<span class="math notranslate nohighlight">\(\Upsilon_j\)</span> is the Fourier transform of <span class="math notranslate nohighlight">\(\epsilon_n\)</span>,
and <span class="math notranslate nohighlight">\(j\)</span> indicates a discrete frequency index.  Multiplying both sides of this equation by the complex conjugate of the Fourier transform of <span class="math notranslate nohighlight">\(x\)</span>,</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
Y_j \, X_j^*	&amp;= \gamma_j X_j \, X_j^*+ \Upsilon_j \, X_j^* \, ,
\end{align*}
\]</div>
<p>and averaging this result across the trials of data, we find,</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
&lt; Y_j \, X_j^* &gt;	&amp;= \gamma_j &lt; X_j \, X_j^*&gt; + &lt; \Upsilon_j \, X_j^*&gt; \, ,
\end{align*}
\]</div>
<p>where we have used the notation <span class="math notranslate nohighlight">\(&lt; \, &gt;\)</span> to indicate the trial average.
Assuming that the noise term and signal <span class="math notranslate nohighlight">\(x\)</span> are unrelated, their trial average is zero (i.e.,  $ &lt; \Upsilon_j , X_j^*&gt; = 0$).  Solving for <span class="math notranslate nohighlight">\(\gamma_j\)</span> we find,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
\gamma_j  	&amp;= \dfrac{&lt; Y_j \, X_j^* &gt;}{&lt; X_j \, X_j^*&gt;} \, , \notag \\
			&amp;= \dfrac{&lt; S_{xy,j} &gt;}{&lt; S_{xx,j} &gt;} \, .
\end{align}
\end{split}\]</div>
<p>Then, comparing this expression to the <a class="reference external" href="#eq:cohr">equation for coherence</a><span class="thumb"><sup>eq</sup><img src="imgs/eqcohr.png"></span> we find,</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
\kappa_{xy,\, j} =  \mid \gamma_j \mid \dfrac{\sqrt{&lt;S_{xx, \, j}&gt;}}{\sqrt{&lt;S_{yy, \, j}&gt;}} \, .
\end{align}
\]</div>
<p>We conclude that the coherence (<span class="math notranslate nohighlight">\(\kappa_{xy,\, j}\)</span>) is a scaled version of the frequency domain representation of the statistical model coefficients (<span class="math notranslate nohighlight">\(\gamma_j\)</span>) for predicting <span class="math notranslate nohighlight">\(y\)</span> from <span class="math notranslate nohighlight">\(x\)</span>. We note that <span class="math notranslate nohighlight">\(\gamma_j\)</span> is a complex quantity that allows us to model both the magnitude and phase of the relationship between <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>.  The phase difference computed from the model and the coherence is the same as well.</p>
<p><a class="reference external" href="#top">Return to top</a></p>
<p><a id="summary"></a></p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this module, we analyzed ECoG data recorded from two electrodes during an auditory task. The task involved the repeated presentation of auditory stimuli, resulting in 100 trials of 1 s duration recorded simultaneously from the two electrodes. We began the analysis with visual inspection of individual trials and of all trials at once. Then, to assess the relations between the two recordings, we computed the cross-covariance. We discussed how the cross-covariance is an extension of the autocovariance, and found that the single-trial cross-covariance between the ECoG signals exhibited periodic structure, consistent with rhythmic coupling of period 0.125 s. However, the trial-averaged cross-covariance provided less evidence for consistent rhythmic coupling across trials. We then computed the trial-averaged spectrum and found a large peak near 8 Hz and a much smaller peak near 24 Hz.</p>
<p>To further assess the relation between the two electrodes, we computed the coherence. The coherence is strong (approaches 1) at a chosen frequency <span class="math notranslate nohighlight">\(f_0\)</span> when there exists a constant phase relation at frequency <span class="math notranslate nohighlight">\(f_0\)</span> between two electrodes over trials. We found a strong coherence between the two ECoG electrodes only at 24 Hz. We concluded that although both ECoG signals possessed dominant rhythms at 8 Hz, these rhythms were not coherent between the two electrodes. The strong coherence appeared only at the small-amplitude 24 Hz rhythm. Finally, we implemented a technique to visualize the distribution of phase differences between the two electrodes across trials, and provided some suggestions for how to compute the coherence for a single trial of data.</p>
<div class="python-note">
<p><strong>Caution!</strong> Large amplitude does not imply large coherence.</p>
</div><p>In this example, only the coherence revealed the low-amplitude coupling at 24 Hz between the two ECoG electrodes. This coupling was not obvious in the single-trial or trial-averaged cross-covariance. In fact, the single-trial cross-covariance was deceiving; we found <a class="reference external" href="#fig:xc_1">strong single-trial cross-covariance</a><span class="fig"><sup>fig</sup><img src="imgs/xc_1.png"></span> with period 0.125 s, or 8 Hz, yet no coherence at 8 Hz.</p>
<p>To understand this discrepancy, consider two unrelated signals, each dominated by the same rhythm. By unrelated we mean that the signals do not communicate in any way. Yet both are rhythmic and happen to oscillate at the same frequency. If we compute the cross-covariance between these two unrelated signals, we will find periodic lags at which the two signals nearly overlap and the cross-covariance is large. The period of these cross-covariance peaks corresponds to the period of the common rhythm shared by the two signals. Here the periodic, large cross-covariance values occur because the two signals happen to both exhibit a similar rhythm, not because one signal influences the other.</p>
<p>This example illustrates a point of caution in the interpretation of cross-covariance results. Unrelated signals that happen to share a similar dominant rhythm will exhibit large periodic structure in the cross-covariance. One approach to defend against such cross-covariance results is to compute the trial-averaged cross-covariance. If two signals are unrelated—to one another and to the trial structure—then we do not expect similar cross-covariance functions across trials. Therefore, although each single-trial cross-covariance may have large values at some lags, their average across trials will be small. This is just what we found<a class="sup" href="#fig:avg_xc">fig<img src="imgs/avg_xc.png"></a> for the ECoG data examined here. We note that the unrelated 8 Hz signals, which dominate the ECoG activity at each electrode, mask the much smaller amplitude 24 Hz activity that is coupled between the two electrodes. The coupling at 24 Hz is not apparent in the trial-averaged cross-covariance<a href="#fig:avg_xc" class="sup">fig<img src="imgs/avg_xc.png"></a>. The coherence, which normalizes by the power at each frequency, uncovers this relation.</p>
<p>As is true for the Fourier transform and spectrum, there exists a vast literature on computing and interpreting the coherence. Some references for further reading include:</p>
<ul class="simple">
<li><p><a href="https://doi.org/10.1017/CBO9780511622762" rel="external">Percival &amp; Walden, 1998</a></p></li>
<li><p><a href="https://www.elsevier.com/books/spectral-analysis-and-time-series-two-volume-set/priestley/978-0-08-057055-6" rel="external">Priestly, 1982</a></p></li>
<li><p><a href="http://numerical.recipes/" rel="external">Numerical recipes</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "Mark-Kramer/Case-Studies-Python",
            ref: "binder",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "."
        }
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="04.html" title="previous page">The Power Spectrum (Part 2)</a>
    <a class='right-next' id="next-link" href="06.html" title="next page">Filtering Field Data</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Mark Kramer and Uri Eden<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="_static/js/index.js"></script>
    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'G-54QV706BYJ', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    
  </body>
</html>